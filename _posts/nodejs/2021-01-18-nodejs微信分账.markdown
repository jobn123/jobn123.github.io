---
layout:     post
title:      "Nodejså®ç°å¾®ä¿¡åˆ†è´¦"
subtitle:   "ğŸ’°"
date:       2021-01-18 12:00:00
author:     "Hiz"
header-img: "img/post-bg-2015.jpg"
catalog: true
tags:
    - Nodejs
    - å¾®ä¿¡å°ç¨‹åº
---

å…¬å¸çš„ä¸šåŠ¡çš„åœºæ™¯éœ€è¦ç”¨åˆ°å¾®ä¿¡åˆ†è´¦çš„åŠŸèƒ½ã€å¯¹ç€å®˜ç½‘æ–‡æ¡£è°ƒè¯•äº†ä¸€ä¸‹åˆæ‰è°ƒé€šã€è®°å½•ä¸‹ä½¿ç”¨Nodejså¾®ä¿¡åˆ†è´¦çš„æµç¨‹ã€‚

# å‰ææ¡ä»¶
* åœ¨å¾®ä¿¡å•†æˆ·å¹³å° äº§å“ä¸­å¿ƒ->æˆ‘çš„äº§å“ï¼Œæ”¯ä»˜æ‰©å±•å·¥å…·ä¸­ å¼€é€šåˆ†è´¦çš„åŠŸèƒ½
* æ·»åŠ åˆ†è´¦æ¥æ”¶æ–¹ã€‚
  è¿™ä¸€æ­¥ä¸è®¾ç½®çš„è¯å›æŠ¥ä¸€ä¸ª*åˆ†è´¦æ¥æ”¶æ–¹å…³ç³»ä¸å­˜åœ¨ï¼Œè¯·æ£€æŸ¥å‚æ•°ä¸­æ¯ä¸ªæ¥æ”¶æ–¹çš„å…³ç³»ã€‚*é”™è¯¯
* åœ¨å•†æˆ·å¹³å°è·å–å•†æˆ·idå’Œsecrect
* éœ€è¦å°†apiclient_cert.pemã€ apiclient_keyä¼ åˆ°æœåŠ¡å™¨æŸä¸ªç›®å½•ä¸‹é¢

# å…·ä½“å®ç°

```javascript

// @router post -> share -> /common/payment/share
async share() {
  const { ctx } = this
  const nonce_str = ctx.service.wx.randomStr()
  // å•†æˆ·id
  const mch_id = '123456'
  // xå°ç¨‹åºappid
  const appid = 'wx123456'
  // è®¢å•å·
  const out_order_no = '1609745196755nFvdMaYub2'
  // å¾®ä¿¡æ”¯ä»˜è®¢å•å·
  const transaction_id = '4200000801202101044301662433'
  // å•†æˆ·secrect
  const key = '9813490da1ffb80afaa36f6f1265e490'

  // è¿™ä¸€å—çš„å‚æ•°å®˜ç½‘æ–‡æ¡£ä¸Šæœ‰è¯¦ç»†çš„è¯´æ˜
  const params = {
    appid,
    mch_id,
    nonce_str,
    out_order_no,
    receivers: `[{"account": "123qwe","amount": 1,"description": "description","type": "PERSONAL_OPENID"}]`,
    sign_type: 'HMAC-SHA256',
    transaction_id,
  }

  // ç­¾åæ–¹å¼å¿…é¡»æ˜¯HMAC-SHA256
  const sign = ctx.service.wx.sign(params, key, 'HMAC-SHA256')

  // xmlString
  const formData = `<xml>
    <appid>${appid}</appid>
    <mch_id>${mch_id}</mch_id>
    <nonce_str>${nonce_str}</nonce_str> 
    <out_order_no>${out_order_no}</out_order_no>
    <transaction_id>${transaction_id}</transaction_id>
    <sign>${sign}</sign>
    <sign_type>HMAC-SHA256</sign_type>
    <receivers>${params.receivers}</receivers>
  </xml>`

  const res = await ctx.curl(
    "https://api.mch.weixin.qq.com/secapi/pay/profitsharing",
    {
      // éœ€è¦ä½¿ç”¨è¯ä¹¦apiclient_cert
      cert: fs.readFileSync(path.join(__dirname,'../../../cert/apiclient_cert.pem')),
      // éœ€è¦ä½¿ç”¨è¯ä¹¦apiclient_key
      key: fs.readFileSync(path.join(__dirname,'../../../cert/apiclient_key.pem')),
      method: "post",
      data: formData,
    }
  )

  const datastring = res.data.toString()
  xml2js.parseString(datastring, (err, result) => {
    if (err) {
      ctx.throw(422, err)
    }

    console.log(result)
  })
}


// randomStr
// ç”Ÿæˆéšæœºå­—ç¬¦ä¸²
randomStr(len = 24) {
  const str =
    'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
  let result = '';
  for (let i = 0; i < len; i++) {
    result += str[Math.floor(Math.random() * str.length)];
  }
  return result;
}

// ç­¾å
// mchKeyæ˜¯å•†æˆ·secrectï¼Œå¦åˆ™ç­¾åä¸é€šè¿‡
sign(data, mchKey, signType = 'MD5') {
  const keys = [];
  for (const key in data) {
    if (data[key] !== undefined) {
      keys.push(key);
    }
  }
  // å­—å…¸æ’åº=>key=value
  const stringA = keys
    .sort()
    .map(key => `${key}=${decodeURIComponent(data[key])}`)
    .join('&');
  // æ‹¼æ¥å•†æˆ·key
  const stringSignTemp = stringA + '&key=' + mchKey;
  // åŠ å¯†
  let hash;
  if (signType === 'MD5') {
    hash = crypto.createHash('md5').update(stringSignTemp);
  } else {
    hash = crypto.createHmac('sha256', mchKey).update(stringSignTemp, 'utf8');
  }
  
  const paySign = hash.digest('hex').toUpperCase();
  return paySign;
}
```

å¦‚æœé‡åˆ°ç­¾åä¸é€šè¿‡çš„é—®é¢˜ã€‚å¯ä»¥å°†ä½ ç”Ÿæˆçš„formDataæ”¾åˆ°[æ¥å£ç­¾åæ ¡éªŒå·¥å…·](https://pay.weixin.qq.com/wiki/doc/api/jsapi.php?chapter=20_1)è¿›è¡Œé€æ­¥éªŒè¯ã€

![1610961537272](https://gitee.com/inkkk0516/typora/raw/master/1610961537272.jpg)

[åˆ†è´¦æ¥å£å…¶ä»–å¸¸è§é—®é¢˜](https://developers.weixin.qq.com/community/pay/doc/000284823e8460aada68dacca5b008?blockType=8)

