---
layout:     post
title:      "Nodejså®ç°å¾®ä¿¡å°ç¨‹åºæ¶ˆæ¯æ¨é€"
subtitle:   " ğŸ“¬ "
date:       2021-01-19 12:00:00
author:     "Hiz"
header-img: "img/post-bg-2015.jpg"
catalog: true
tags:
    - Nodejs
    - å¾®ä¿¡å°ç¨‹åº
---

# é€‰æ‹©æˆ–åˆ›å»ºè®¢é˜…æ¶ˆæ¯æ¨¡æ¿
ç™»å½•åˆ°å¾®ä¿¡å°ç¨‹åºé‡Œé¢æ‰¾åˆ°*åŠŸèƒ½->è®¢é˜…æ¶ˆæ¯*ã€‚å¯ä»¥åœ¨å…¬å…±æ¨¡æ¿åº“é‡Œé€‰æ‹©éœ€è¦çš„æ¨¡æ¿ï¼Œå¦‚æœæ²¡æœ‰æ‰¾åˆ°è‡ªå·±éœ€è¦çš„ä¹Ÿå¯ä»¥è‡ªå·±åˆ›å»ºç„¶åç­‰å¾…å®¡æ ¸ã€

é€‰æ‹©å®Œæ¨¡æ¿æŸ¥çœ‹è¯¦æƒ…ä¼šå¾—åˆ°æ¨¡æ¿ID,ä»¥åŠå‘é€æ¨é€æ—¶éœ€è¦çš„å­—æ®µã€

<img src="https://gitee.com/inkkk0516/typora/raw/master/1611045929323.jpg" alt="1611045929323" style="zoom:50%;" />

# å°ç¨‹åºå‘é€è®¢é˜…çš„è¯·æ±‚

éœ€è¦ç”¨åˆ°ä¸Šä¸€æ­¥è·å–çš„æ¨¡æ¿Id

```react
// å°ç¨‹åº
<Text className='rights-buy' onClick={this.messageSubmit}>
  å…¥é©»ç”³è¯·
</Text>

// å…¥é©»ç”³è¯·æ¶ˆæ¯è®¢é˜…
messageSubmit = () => {
  Taro.requestSubscribeMessage({
    tmplIds: ['SuGMwqyYY9cocuP-LxfElcM3a7ITaF34lKNux6EaE9'],
    success: (res) => {
      // è°ƒç”¨æœåŠ¡ç«¯æ¥å£,åœ¨æ•°æ®åº“å†™å…¥ä¸€æ¡è®¢é˜…è®°å½•
      // this.subscribeDeal()
    }
  })
}
```

# æœåŠ¡ç«¯å‘èµ·æ¨é€
æ¨é€ä¸€èˆ¬æœ‰ä¸¤ç§
* æ‰‹åŠ¨è§¦å‘ï¼Œä¾‹å¦‚å®¡æ ¸æœªé€šè¿‡ã€ç„¶åè°ƒç”¨æ¨é€æ¥å£ã€
* è¿˜æœ‰å°±æ˜¯è®¢é˜…æ¶ˆæ¯åï¼Œè¾¾åˆ°æŸä¸ªæ¡ä»¶è‡ªåŠ¨è§¦å‘æ¨é€ã€

å¯¹äºç¬¬ä¸€ç§æƒ…å†µï¼Œå°±ç›´æ¥è°ƒç”¨å¾®ä¿¡çš„æ¨é€æ¥å£å°±å¥½äº†ã€‚ç¬¬äºŒä¸­æƒ…å†µç¨å¾®éº»çƒ¦ä¸€ç‚¹ï¼Œå¯ä»¥åŠ ä¸€ä¸ªå®šæ—¶çš„ä»»åŠ¡ï¼Œæˆ–è€…ä½¿ç”¨ç›¸å…³çš„é˜Ÿåˆ—åº“ã€ç­‰æ¡ä»¶ç¬¦åˆäº†å†è§¦å‘ã€

**éœ€è¦æ³¨æ„çš„åœ°æ–¹**
* å‘é€æ¨é€çš„æ—¶å€™éœ€è¦ç”¨æˆ·çš„*openid*,ä»¥åŠæ¨¡æ¿idã€‚å…·ä½“çš„æ¨é€å†…å®¹å­—æ®µï¼Œåœ¨ç¬¬ä¸€æ­¥æ¨¡æ¿è¯¦æƒ…é‡Œé¢å¯ä»¥æŸ¥çœ‹ã€
* è°ƒç”¨å¾®ä¿¡æ¨é€çš„æ¥å£çš„æ—¶å€™éœ€è¦*access_token*ï¼Œæœ€å¥½ç¼“å­˜ä¸€ä¸‹ï¼Œé¢‘ç¹è°ƒç”¨ä¼šæœ‰å¤±æ•ˆçš„é—®é¢˜ã€

è·å–access_tokenå¹¶ç¼“å­˜
```javascript
async getAccessToken () {
  const { appId, appSecert, host } = this.app.config.idolWxAConfig;

  return new Promise(async (resolve) => {
    const currentTime = new Date().getTime()

    const redisToken = await this.app.redis.get('wxtoken').get('token') || '{access_token: "", expries_time: 0}'
    const accessTokenJson = JSON.parse(redisToken)

    if (accessTokenJson.access_token === '' || accessTokenJson.expries_time < currentTime) {
      const res = await this.ctx.curl(`${host}/cgi-bin/token?appid=${appId}&secret=${appSecert}&grant_type=client_credential`, { dataType: 'json' })

      if (res.data) {

        accessTokenJson.access_token = res.data.access_token
        accessTokenJson.expries_time = new Date().getTime() + (parseInt(res.data.expires_in) - 200) * 1000

        await this.app.redis.get('wxtoken').set('token', JSON.stringify(accessTokenJson))
        resolve(accessTokenJson)
      }
    } else {
      resolve(accessTokenJson)
    }
  })
}
```
å‘å¾®ä¿¡å‘é€æ¨é€è¯·æ±‚
```javascript
async sendSubscribeMsg (openid) {

  let requestData = {
    "touser": `${openid}`,
    "template_id": "SuGMwqyYY9cocuP-LxfElcM3a7ITaF34lKNux6EaE9",
    "page": `/pages/certification/index`,
    "data": {
        "phrase2": {
          "value": `å®¡æ ¸é€šè¿‡`
        },
        "thing3": {
          "value": `æ‚¨çš„ç”³è¯·å·²ç»å®¡æ ¸é€šè¿‡`
        }
    }
  }

  const { host } = this.app.config.idolWxAConfig;
  // è·å–access_toekn
  const tokenJson = await this.ctx.service.wx.getAccessToken()
  const res = await this.ctx.curl(`${host}/cgi-bin/message/subscribe/send?access_token=${tokenJson.access_token}
  `, {
    method: 'POST',
    contentType: 'json',
    data: requestData,
    dataType: 'json'
  });

  if (res.data.errmsg === 'ok') {
    console.log('========æ¨é€æˆåŠŸ========')
    // TODO
  } else {
    console.log('========æ¨é€å¤±è´¥========')
    // TODO
  }
}
```
